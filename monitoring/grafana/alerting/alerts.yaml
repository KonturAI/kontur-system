apiVersion: 1

groups:
    -   orgId: 1
        name: infrastructure_alerts
        folder: Infrastructure
        interval: 1m
        rules:
            # –û–ó–£
            -   uid: ram_usage_alert
                title: High RAM Usage
                condition: C  # ‚Üê –£–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ threshold
                data:
                    # –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö
                    -   refId: A
                        relativeTimeRange:
                            from: 300
                            to: 0
                        datasourceUid: victoria-metrics
                        model:
                            expr: 'clamp_min((1 - (node_memory_MemAvailable_bytes{instance="loom-node-exporter:9100", job="infrastructure"} / node_memory_MemTotal_bytes{instance="loom-node-exporter:9100", job="infrastructure"})) * 100, 0)'
                            refId: A

                    # Reduce: –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                    -   refId: B
                        datasourceUid: __expr__
                        model:
                            type: reduce
                            expression: A
                            reducer: last
                            refId: B

                    # Threshold: –ø–æ—Ä–æ–≥ 80%
                    -   refId: C
                        datasourceUid: __expr__
                        model:
                            type: threshold
                            expression: B
                            conditions:
                                -   evaluator:
                                        params: [10]  # ‚Üê –ü–æ—Ä–æ–≥
                                        type: gt      # greater than
                                    type: query
                            refId: C

                noDataState: NoData
                execErrState: Error
                for: 5m
                annotations:
                    summary: '‚ö†Ô∏è –í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RAM'
                    description: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RAM: {{ printf "%.2f" $values.A.Value }}%'
                labels:
                    severity: warning
                    component: memory

            # –¶–ü–£
            -   uid: cpu_usage_alert
                title: High CPU Usage
                condition: C
                data:
                    -   refId: A
                        relativeTimeRange:
                            from: 300
                            to: 0
                        datasourceUid: victoria-metrics
                        model:
                            expr: '100 * (1 - avg(rate(node_cpu_seconds_total{mode="idle", instance="loom-node-exporter:9100"}[2m])))'
                            refId: A

                    -   refId: B
                        datasourceUid: __expr__
                        model:
                            type: reduce
                            expression: A
                            reducer: last
                            refId: B

                    -   refId: C
                        datasourceUid: __expr__
                        model:
                            type: threshold
                            expression: B
                            conditions:
                                -   evaluator:
                                        params: [75]  # –ü–æ—Ä–æ–≥ 75%
                                        type: gt
                                    type: query
                            refId: C

                noDataState: NoData
                execErrState: Error
                for: 3m
                annotations:
                    summary: '‚ö†Ô∏è –í—ã—Å–æ–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ CPU'
                    description: '–ó–∞–≥—Ä—É–∑–∫–∞ CPU: {{ printf "%.2f" $values.A.Value }}%'
                labels:
                    severity: warning
                    component: cpu

            # –î–∏—Å–∫
            -   uid: disk_usage_alert
                title: High Disk Usage
                condition: C
                data:
                    -   refId: A
                        relativeTimeRange:
                            from: 300
                            to: 0
                        datasourceUid: victoria-metrics
                        model:
                            expr: '((node_filesystem_size_bytes{instance="loom-node-exporter:9100", job="infrastructure", mountpoint="/", fstype!="rootfs"} - node_filesystem_avail_bytes{instance="loom-node-exporter:9100", job="infrastructure", mountpoint="/", fstype!="rootfs"}) / node_filesystem_size_bytes{instance="loom-node-exporter:9100", job="infrastructure", mountpoint="/", fstype!="rootfs"}) * 100'
                            refId: A

                    -   refId: B
                        datasourceUid: __expr__
                        model:
                            type: reduce
                            expression: A
                            reducer: last
                            refId: B

                    -   refId: C
                        datasourceUid: __expr__
                        model:
                            type: threshold
                            expression: B
                            conditions:
                                -   evaluator:
                                        params: [85]  # –ü–æ—Ä–æ–≥ 85%
                                        type: gt
                                    type: query
                            refId: C

                noDataState: NoData
                execErrState: Error
                for: 10m
                annotations:
                    summary: 'üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∏—Å–∫–∞'
                    description: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞: {{ printf "%.2f" $values.A.Value }}%'
                labels:
                    severity: critical
                    component: disk